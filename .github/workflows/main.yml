name: Update Comprehensive SRS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install dnspython requests

      - name: Install sing-box
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')
          VERSION_NUM=${LATEST_TAG#v}
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${VERSION_NUM}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .
          chmod +x sing-box

      # ----------------------------------------------------------------
      # é˜¶æ®µ 1: åŸºç¡€åˆå¹¶ (FakeIP åˆå§‹åˆ—è¡¨ç”Ÿæˆ)
      # ----------------------------------------------------------------
      - name: Advanced Consensus Merge (FakeIP)
        run: |
          curl -sL "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json" -o s1.json
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o s2.srs
          ./sing-box rule-set decompile s2.srs -o s2.json
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o s3.list

          python3 -c "
          import json, re, os

          registry = {}
          def register(val, r_type, source_id):
              val = val.strip().lower()
              if not val or len(val) < 3 or ' ' in val or '/' in val or ':' in val: return
              if re.match(r'^\d{1,3}(\.\d{1,3}){3}$', val): return
              if val not in registry:
                  registry[val] = {'sources': set(), 'types': set()}
              registry[val]['sources'].add(source_id)
              registry[val]['types'].add(r_type)

          def load_json(path, sid):
              if not os.path.exists(path): return
              with open(path, 'r') as f:
                  data = json.load(f)
                  for r in data.get('rules', []):
                      for x in r.get('domain', []): register(x, 'domain', sid)
                      for x in r.get('domain_suffix', []): register(x, 'suffix', sid)

          load_json('s1.json', 'S1')
          load_json('s2.json', 'S2')
          if os.path.exists('s3.list'):
              with open('s3.list', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('#'): continue
                      if line.startswith('+.') or line.startswith('.'):
                          register(re.sub(r'^[+.]+', '', line), 'suffix', 'S3')
                      else: register(line, 'domain', 'S3')

          final_rules = {'domain_suffix': []}
          for val, info in registry.items():
              if 'S1' in info['sources'] or len(info['sources']) >= 2:
                  final_rules['domain_suffix'].append(val)

          # è¾“å‡ºåŸºç¡€æ–‡ä»¶
          output = {'version': 3, 'rules': [final_rules]}
          with open('fakeip-filter.json', 'w') as f:
              json.dump(output, f, indent=2)
          "

      # ----------------------------------------------------------------
      # é˜¶æ®µ 2: æ™ºèƒ½æ¸…æ´— (åˆ†ç±» Remote DNS)
      # ----------------------------------------------------------------
      - name: Smart Classification (Remote DNS Optimization)
        run: |
          curl -sL "https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes.txt" -o chnroutes.txt
          curl -sL "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/sing/geo/geosite/cn.json" -o geosite-cn.json

          python3 -c "
          import json, dns.resolver, ipaddress, concurrent.futures, os

          # 1. é™æ€é»‘åå•ï¼šæ˜ç¡®ä¸éœ€è¦èµ° Remote DNS çš„åŸŸåï¼ˆæœ¬åœ°/ç§æœ‰/é˜¿é‡Œ/è…¾è®¯ç­‰ï¼‰
          LOCAL_TLDS = {'.cn', '.lan', '.local', '.home.arpa', '.localdomain', '.aliyun.com', '.alicdn.com', '.qq.com', '.tencent.com', '.baidu.com', '.beian.gov.cn'}
          
          # 2. åŠ è½½ CN è·¯ç”±è¡¨
          cn_networks = [ipaddress.ip_network(line.strip()) for line in open('chnroutes.txt') if line.strip() and not line.startswith('#')]
          
          # 3. åŠ è½½ Geosite-CN ç™½åå•
          cn_whitelist = set()
          try:
              with open('geosite-cn.json', 'r') as f:
                  g_data = json.load(f)
                  for r in g_data.get('rules', []):
                      for d in r.get('domain', []) + r.get('domain_suffix', []):
                          cn_whitelist.add(d.lower())
          except: pass

          resolver = dns.resolver.Resolver()
          resolver.nameservers = ['223.5.5.5', '119.29.29.29'] # ä½¿ç”¨å›½å†… DNS æ¢æµ‹ä»¥ç¡®å®šæ˜¯å¦ä¸ºå›½å†… IP
          resolver.timeout = 1.5
          resolver.lifetime = 1.5

          def is_local(domain):
              domain = domain.lower()
              # è§„åˆ™ A: é™æ€åç¼€æ£€æŸ¥
              if any(domain.endswith(tld) for tld in LOCAL_TLDS): return True
              # è§„åˆ™ B: Geosite-CN åŒ¹é…
              parts = domain.split('.')
              for i in range(len(parts)):
                  if '.'.join(parts[i:]) in cn_whitelist: return True
              # è§„åˆ™ C: åŠ¨æ€ DNS æ¢æµ‹
              try:
                  answers = resolver.resolve(domain, 'A')
                  for rdata in answers:
                      ip_str = rdata.to_text()
                      ip_obj = ipaddress.ip_address(ip_str)
                      if ip_obj.is_private: return True # ç§æœ‰åœ°å€ (192.168 / 10.x)
                      if any(ip_obj in net for net in cn_networks): return True
              except: pass
              return False

          # åŠ è½½å¾…å¤„ç†åˆ—è¡¨
          with open('fakeip-filter.json', 'r') as f:
              data = json.load(f)
          
          raw_domains = set()
          for r in data.get('rules', []):
              for d in r.get('domain_suffix', []): raw_domains.add(d.lower())

          print(f'Processing {len(raw_domains)} domains...')

          # å¹¶å‘åˆ†ç±»
          with concurrent.futures.ThreadPoolExecutor(max_workers=30) as executor:
              results = list(executor.map(lambda d: (d, is_local(d)), raw_domains))
          
          # ç­›é€‰å‡ºè¿œç¨‹åŸŸå
          remote_dns_list = [d for d, local in results if not local]

          # 4. åç¼€å»é‡ä¼˜åŒ– (Suffix Pruning)
          # å¦‚æœå­˜åœ¨ 'google.com'ï¼Œåˆ™åˆ é™¤ 'www.google.com'
          remote_dns_list.sort(key=len)
          final_remote = []
          for d in remote_dns_list:
              is_sub = False
              for existing in final_remote:
                  if d.endswith('.' + existing):
                      is_sub = True
                      break
              if not is_sub:
                  final_remote.append(d)

          # å†™å…¥ç»“æœ
          output_data = {'version': 3, 'rules': [{'domain_suffix': sorted(final_remote)}]}
          with open('fakeip-filter-Remote-DNS.json', 'w') as f:
              json.dump(output_data, f, indent=2)
          "
          ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs

      # ----------------------------------------------------------------
      # é˜¶æ®µ 3: WebRTC å¤„ç†ä¸æœ€ç»ˆæ¸…ç†
      # ----------------------------------------------------------------
      - name: Finalize
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o webRTC.json
          # ç¡®ä¿ webRTC ä¹Ÿæ˜¯ version 3
          python3 -c "import json; d=json.load(open('webRTC.json')); open('webRTC.json','w').write(json.dumps({'version':3,'rules':d.get('rules',[])},indent=2))"
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          rm -f s1.json s2.json s2.srs s3.list chnroutes.txt geosite-cn.json sing-box sing-box.tar.gz
          
          git add *.json *.srs
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "ğŸ”§ Logic Update: Enhanced Remote DNS Classification $(date +'%Y-%m-%d')"
            git push origin main --force
          fi
