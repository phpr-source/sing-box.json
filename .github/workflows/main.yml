name: Update Comprehensive SRS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹è¿è¡Œ
  push:
    paths:
      - '.github/workflows/**'
      - 'fakeip-filter-Remote-DNS.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install sing-box
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')
          VERSION_NUM=${LATEST_TAG#v}
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${VERSION_NUM}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .
          chmod +x sing-box

      # ----------------------------------------------------------------
      # ä»»åŠ¡ A: Adblock è§„åˆ™æ„å»º
      # ----------------------------------------------------------------
      - name: Task A - Build Adblock SRS
        run: |
          curl -sL "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json" -o Adblock.json
          ./sing-box rule-set compile Adblock.json -o Adblock.srs

      # ----------------------------------------------------------------
      # ä»»åŠ¡ B: FakeIP-Filter æ„å»º (ä¿æŒåŸå§‹åŸŸåæ ¼å¼ + æ’åº)
      # ----------------------------------------------------------------
      - name: Task B - Consensus Merge
        run: |
          curl -sL "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json" -o s1.json
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o s2.srs
          ./sing-box rule-set decompile s2.srs -o s2.json
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o s3.list

          python3 -c "
          import json, os
          registry = {} 

          def add_to_reg(val, r_type, src):
              val = val.strip()
              if not val: return
              # ä½¿ç”¨ (ç±»å‹, å€¼) ä½œä¸º Keyï¼Œä½†å€¼ä¿æŒåŸå§‹å¤§å°å†™
              key = (r_type, val)
              if key not in registry: registry[key] = set()
              registry[key].add(src)

          # åŠ è½½ S1 (JSON)
          with open('s1.json', 'r') as f:
              d = json.load(f)
              for r in d.get('rules', []):
                  for k in ['domain', 'domain_suffix', 'domain_keyword', 'domain_regex']:
                      for v in r.get(k, []): add_to_reg(v, k, 'S1')

          # åŠ è½½ S2 (JSON)
          with open('s2.json', 'r') as f:
              d = json.load(f)
              for r in d.get('rules', []):
                  for k in ['domain', 'domain_suffix', 'domain_keyword', 'domain_regex']:
                      for v in r.get(k, []): add_to_reg(v, k, 'S2')

          # åŠ è½½ S3 (List)
          if os.path.exists('s3.list'):
              for line in open('s3.list'):
                  l = line.strip()
                  if not l or l.startswith('#'): continue
                  if l.startswith('.'): add_to_reg(l.lstrip('.'), 'domain_suffix', 'S3')
                  else: add_to_reg(l, 'domain', 'S3')

          # åˆå¹¶é€»è¾‘ï¼šS1 å­˜åœ¨ æˆ– (S2 ä¸” S3 å­˜åœ¨)
          final_rules = {'domain': [], 'domain_suffix': [], 'domain_keyword': [], 'domain_regex': []}
          for (r_type, val), sources in registry.items():
              if 'S1' in sources or ('S2' in sources and 'S3' in sources):
                  final_rules[r_type].append(val)

          # ä¿®æ­£é¡ºåºï¼šæ’åºè¾“å‡º
          output = {'version': 3, 'rules': [{k: sorted(v) for k, v in final_rules.items() if v}]}
          with open('fakeip-filter.json', 'w') as f:
              json.dump(output, f, indent=2)
          "
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      # ----------------------------------------------------------------
      # ä»»åŠ¡ C: ç¼–è¯‘æ‰‹åŠ¨ç»´æŠ¤çš„ Remote-DNS
      # ----------------------------------------------------------------
      - name: Task C - Compile Manual Remote-DNS
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          else
            echo "Warning: fakeip-filter-Remote-DNS.json not found."
          fi

      # ----------------------------------------------------------------
      # ä»»åŠ¡ D: WebRTC å¤„ç†ä¸æœ€ç»ˆæ¨é€
      # ----------------------------------------------------------------
      - name: Stage 3 - Finalize
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o raw_webrtc.json
          python3 -c "import json; d=json.load(open('raw_webrtc.json')); open('webRTC.json','w').write(json.dumps({'version': 3, 'rules': d.get('rules', [])}, indent=2))"
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

          rm -f s1.json s2.json s2.srs s3.list raw_webrtc.json sing-box sing-box.tar.gz
          
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          git add *.json *.srs
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸš€ Sync: Maintain Original Domain Format & Sort Rules ($(date +'%Y-%m-%d'))"
            git push origin main
          fi
